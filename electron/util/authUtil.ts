import { Credentials } from "../lib/league-connect";
import logger from "../lib/logger";
import { executeCommand } from "./util";

const RIOT_GAMES_CERT = `
-----BEGIN CERTIFICATE-----
MIIEIDCCAwgCCQDJC+QAdVx4UDANBgkqhkiG9w0BAQUFADCB0TELMAkGA1UEBhMC
VVMxEzARBgNVBAgTCkNhbGlmb3JuaWExFTATBgNVBAcTDFNhbnRhIE1vbmljYTET
MBEGA1UEChMKUmlvdCBHYW1lczEdMBsGA1UECxMUTG9MIEdhbWUgRW5naW5lZXJp
bmcxMzAxBgNVBAMTKkxvTCBHYW1lIEVuZ2luZWVyaW5nIENlcnRpZmljYXRlIEF1
dGhvcml0eTEtMCsGCSqGSIb3DQEJARYeZ2FtZXRlY2hub2xvZ2llc0ByaW90Z2Ft
ZXMuY29tMB4XDTEzMTIwNDAwNDgzOVoXDTQzMTEyNzAwNDgzOVowgdExCzAJBgNV
BAYTAlVTMRMwEQYDVQQIEwpDYWxpZm9ybmlhMRUwEwYDVQQHEwxTYW50YSBNb25p
Y2ExEzARBgNVBAoTClJpb3QgR2FtZXMxHTAbBgNVBAsTFExvTCBHYW1lIEVuZ2lu
ZWVyaW5nMTMwMQYDVQQDEypMb0wgR2FtZSBFbmdpbmVlcmluZyBDZXJ0aWZpY2F0
ZSBBdXRob3JpdHkxLTArBgkqhkiG9w0BCQEWHmdhbWV0ZWNobm9sb2dpZXNAcmlv
dGdhbWVzLmNvbTCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBAKoJemF/
6PNG3GRJGbjzImTdOo1OJRDI7noRwJgDqkaJFkwv0X8aPUGbZSUzUO23cQcCgpYj
21ygzKu5dtCN2EcQVVpNtyPuM2V4eEGr1woodzALtufL3Nlyh6g5jKKuDIfeUBHv
JNyQf2h3Uha16lnrXmz9o9wsX/jf+jUAljBJqsMeACOpXfuZy+YKUCxSPOZaYTLC
y+0GQfiT431pJHBQlrXAUwzOmaJPQ7M6mLfsnpHibSkxUfMfHROaYCZ/sbWKl3lr
ZA9DbwaKKfS1Iw0ucAeDudyuqb4JntGU/W0aboKA0c3YB02mxAM4oDnqseuKV/CX
8SQAiaXnYotuNXMCAwEAATANBgkqhkiG9w0BAQUFAAOCAQEAf3KPmddqEqqC8iLs
lcd0euC4F5+USp9YsrZ3WuOzHqVxTtX3hR1scdlDXNvrsebQZUqwGdZGMS16ln3k
WObw7BbhU89tDNCN7Lt/IjT4MGRYRE+TmRc5EeIXxHkQ78bQqbmAI3GsW+7kJsoO
q3DdeE+M+BUJrhWorsAQCgUyZO166SAtKXKLIcxa+ddC49NvMQPJyzm3V+2b1roP
SvD2WV8gRYUnGmy/N0+u6ANq5EsbhZ548zZc+BI4upsWChTLyxt2RxR7+uGlS1+5
EcGfKZ+g024k/J32XP4hdho7WYAS2xMiV83CfLR/MNi8oSMaVQTdKD8cpgiWJk3L
XWehWA==
-----END CERTIFICATE-----
`;

export async function getAuthInfo(): Promise<Credentials> {
	try {
		//使用管道符解决wmic输出utf16le编码到文件的问题
		//https://stackoverflow.com/questions/55310573/wmic-command-in-batch-outputting-non-utf-8-text-files
		const rawStdout = await executeCommand(
			"wmic PROCESS WHERE name='LeagueClientUx.exe' GET commandline /value  | find /v \"\""
		);
		const portRegex = /--app-port=([0-9]+)(?= *"| --)/;
		const passwordRegex = /--remoting-auth-token=(.+?)(?= *"| --)/;
		const pidRegex = /--app-pid=([0-9]+)(?= *"| --)/;
		const commandLineRegex = /CommandLine="(.+?)(?= *")/;
		const stdout = rawStdout.replace(/\n|\r/g, "");
		const [, port] = stdout.match(portRegex) as RegExpMatchArray;
		const [, password] = stdout.match(passwordRegex) as RegExpMatchArray;
		const [, pid] = stdout.match(pidRegex) as RegExpMatchArray;
		let commandLine = "C:\\英雄联盟\\LeagueClient\\LeagueClientUx.exe"
		// const [, commandLine] = stdout.match(commandLineRegex) as RegExpMatchArray;
		logger.info("lcu port: %s password: %s", port, password);
		return {
			port: Number(port),
			pid: Number(pid),
			password,
			certificate: RIOT_GAMES_CERT,
			commandLine
		};
	} catch (e) {
		logger.error("getAuthInfo", e instanceof Error ? e.message : e);
		throw new Error("get LCU process infomation faild");
	}
}
